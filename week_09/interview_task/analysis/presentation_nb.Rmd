---
title: "Cancer incidence in NHS Borders"
output:
  html_document:
    toc: true
    toc_float: true
    css: ../../../../styles.css
    code_folding: hide
  pdf_document: default
---

```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
library(tidyverse)
library(janitor)
library(lubridate)
```

```{r border_code, echo = FALSE, message = FALSE, warning = FALSE}
# assign hb_borders hb code to variable
geography_codes <- read_csv("../data/raw_data/geography_codes_and_labels_hb2014_01042019.csv") %>% 
  clean_names()

hb_borders <- geography_codes %>% 
  filter(hb_name == "NHS Borders") %>% 
  pull(hb)
```


## Cancer types for males and females in NHS Borders

Some cancers are sex-specific, so I have analysed incidence of cancer sites separately for males and females.

```{r data_prep, echo = FALSE, message = FALSE, warning = FALSE}
# 2017 - 2021 combined 5-yr data
comb_5yr_incidence_hb <- read_csv("../data/raw_data/incidence_5yr_comb_hb.csv") %>% 
  clean_names()

# prepare data for incidence by cancer type and age
comb_5_hb_inc_rate_age <- comb_5yr_incidence_hb %>% 
  pivot_longer(cols = c(26:43),
                 names_to = "age_bracket",
               values_to = "incidence_rate") %>% 
  mutate(age_bracket = str_replace(age_bracket, "^incidence_rate_age", ""),
         age_bracket = str_replace(age_bracket, "\\_", ""),
         age_bracket = factor(age_bracket, 
                              levels = c(
                                "under5", "5to9", "10to14", "15to19", "20to24",
                                "25to29", "30to34", "35to39", "40to44", "45to49",
                                "50to54", "55to59", "60to64", "65to69", "70to74",
                                "75to79", "80to84", "85andover"
                              )),
         older_age = if_else(
    age_bracket %in% c("65to69", "70to74", "75to79", "80to84", "85andover"), 
    "65 and over", "Under 65"))

# prepare data tables for females plots
top_cancers_borders_females_means <- comb_5_hb_inc_rate_age %>% 
  filter(hb == hb_borders &
         sex == "Females" & 
           cancer_site != "All cancer types") %>%
  summarise(mean_easr = mean(easr, na.rm=TRUE), .by = cancer_site) %>% 
  arrange(desc(mean_easr)) %>% 
  slice_max(mean_easr, n = 10)

top_cancers_borders_females <- top_cancers_borders_females_means %>% 
  pull(cancer_site)

# prepare data tables for males plots
top_cancers_borders_males_means <- comb_5_hb_inc_rate_age %>% 
  filter(hb == hb_borders &
         sex == "Male" & 
           cancer_site != "All cancer types") %>%
  summarise(mean_easr = mean(easr, na.rm=TRUE), .by = cancer_site) %>% 
  arrange(desc(mean_easr)) %>%
  slice_max(mean_easr, n = 10) %>% 
  mutate(cancer_site = factor(cancer_site, levels = (cancer_site)[order(cancer_site)]))
  
top_cancers_borders_males <- top_cancers_borders_males_means %>%
  pull(cancer_site)
```


For females in NHS Borders, the 10 cancer sites with the highest incidence include breast, cervical and uterine cancers, as well as skin cancers, lung cancer and intestinal cancers. Half of all cancers in females in NHS Borders in the past 5 years (2017-2021) were skin or breast cancer: 44% were skin cancers and 8% were breast cancer.

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# calculate prop new cases (incidences) that are top 10 in females
comb_5yr_incidence_hb %>% 
  filter(sex == "All" &
           hb == hb_borders &
           cancer_site != "All cancer types") %>% # total all cancer types 4156
  select(cancer_site, incidences_all_ages) %>% 
  arrange(desc(incidences_all_ages)) %>% 
  mutate(prop_incidences = 100*(incidences_all_ages / sum(incidences_all_ages))) %>% 
  # sum of individual types 7438
  filter(cancer_site %in% c("Breast", "Non-melanoma skin cancer", "Basal cell carcinoma of the skin", "Squamous cell carcinoma of the skin", "Malignant melanoma of the skin")) %>% 
  mutate(cancer_site = if_else(cancer_site == "Breast", cancer_site, "Skin cancers")) %>% 
  summarise(sum_prop_incidences = sum(prop_incidences), .by = cancer_site)
```

```{r echo = FALSE}
# plot top 10 cancers by mean_easr in females in NHS borders
top_cancers_borders_females_means %>% 
  ggplot() +
  geom_col(aes(x = mean_easr, y = reorder(cancer_site, mean_easr)))
```


```{r echo = FALSE}
# plot top 10 cancers incidence rate by age in females in NHS borders
comb_5_hb_inc_rate_age %>% 
  filter(sex == "Females" & cancer_site %in% top_cancers_borders_females) %>% 
  mutate(cancer_site = factor(cancer_site, levels = c(
    "Breast", "Non-melanoma skin cancer", "Basal cell carcinoma of the skin",
    "Trachea, bronchus and lung", "Colorectal cancer", 
    "Carcinoma in situ of the cervix uteri", "Colon", 
    "Squamous cell carcinoma of the skin", "Uterus", "Malignant melanoma of the skin"
  ))) %>% 
  ggplot(aes(age_bracket, fct_rev(cancer_site), fill = incidence_rate)) +
  geom_tile() +
  scale_fill_viridis_c() +
  labs(x = "Age bracket", y = "Cancer site", fill = "Incidence rate") +
  theme(axis.text.y = element_text(size = 8),
        legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 45, hjust = 1, size = 7),
        axis.title = element_text(size = 14),
        legend.position = "bottom")
```

